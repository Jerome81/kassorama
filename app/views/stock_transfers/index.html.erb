<div class="w-full">
  <div class="flex justify-between items-center mb-6">
    <h1 class="font-bold text-3xl text-[#2C2C2C]">Waren verschieben</h1>
    <%= form_with url: stock_transfers_path, method: :get, class: "flex items-center" do |f| %>
      <%= f.select :supplier_id, options_from_collection_for_select(@suppliers, :id, :name, @selected_supplier_id), { include_blank: "Alle Lieferanten" }, { onchange: "this.form.requestSubmit()", class: "block w-64 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-[#FFD100] focus:border-[#FFD100] sm:text-sm rounded-md shadow-sm cursor-pointer border" } %>
    <% end %>
  </div>

  <% if @locations.empty? %>
    <div class="text-center p-12 bg-white rounded-lg shadow">
       <p class="text-gray-500">No locations defined. Please create a location first.</p>
    </div>
  <% else %>
    <div class="mb-12">
      <h2 class="text-xl font-bold mb-4 text-[#2C2C2C]">Recommended Transfers</h2>
      <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
             <thead class="bg-gray-50">
               <tr>
                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 shadow-sm border-r border-gray-200">
                   Artikel
                 </th>
                 <% @sorted_locations.each_with_index do |location, index| %>
                   <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider <%= 'bg-yellow-50 text-yellow-800 border-x border-yellow-200' if @primary_location && location.id == @primary_location.id %>">
                     <%= location.name %>
                     <% if @primary_location && location.id == @primary_location.id %>
                        <span class="block text-[10px] lowercase font-normal">(Primary)</span>
                     <% end %>
                   </th>
                 <% end %>
                 <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">
                    Verkauft (30d)
                 </th>
                 <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">
                    Aktionen
                 </th>
               </tr>
             </thead>
             <tbody class="bg-white divide-y divide-gray-200">
               <% @grouped_recommended.each do |category, articles| %>
                 <!-- Category Header -->
                 <tr class="bg-gray-100 border-y border-gray-200">
                    <td colspan="<%= 3 + @sorted_locations.count %>" class="px-6 py-3 text-left font-bold text-gray-700 uppercase tracking-wider sticky left-0 z-20 bg-gray-100">
                       <%= category&.name || "Unkategorisiert" %>
                    </td>
                 </tr>

                 <% articles.each do |article| %>
                   <%= render partial: "article_row", locals: { 
                         article: article, 
                         sorted_locations: @sorted_locations, 
                         primary_location: @primary_location, 
                         recent_sales: @recent_sales, 
                         recent_variant_sales: @recent_variant_sales, 
                         other_locations: @other_locations, 
                         selected_supplier_id: @selected_supplier_id 
                       } %>
                 <% end %>
               <% end %>
             </tbody>
          </table>
          <% if @grouped_recommended.empty? %>
             <div class="p-8 text-center text-gray-500">No recommended transfers at this time.</div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- All Articles Section -->
    <div>
      <h2 class="text-xl font-bold mb-4 text-[#2C2C2C]">All Articles</h2>
      <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
             <thead class="bg-gray-50">
               <tr>
                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 shadow-sm border-r border-gray-200">
                   Artikel
                 </th>
                 <% @sorted_locations.each_with_index do |location, index| %>
                   <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider <%= 'bg-yellow-50 text-yellow-800 border-x border-yellow-200' if @primary_location && location.id == @primary_location.id %>">
                     <%= location.name %>
                     <% if @primary_location && location.id == @primary_location.id %>
                        <span class="block text-[10px] lowercase font-normal">(Primary)</span>
                     <% end %>
                   </th>
                 <% end %>
                 <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">
                    Verkauft (30d)
                 </th>
                 <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">
                    Aktionen
                 </th>
               </tr>
             </thead>
             <tbody class="bg-white divide-y divide-gray-200">
               <% @grouped_all.each do |category, articles| %>
                 <!-- Category Header -->
                 <tr class="bg-gray-100 border-y border-gray-200">
                    <td colspan="<%= 3 + @sorted_locations.count %>" class="px-6 py-3 text-left font-bold text-gray-700 uppercase tracking-wider sticky left-0 z-20 bg-gray-100">
                       <%= category&.name || "Unkategorisiert" %>
                    </td>
                 </tr>

                 <% articles.each do |article| %>
                   <%= render partial: "article_row", locals: { 
                         article: article, 
                         sorted_locations: @sorted_locations, 
                         primary_location: @primary_location, 
                         recent_sales: @recent_sales, 
                         recent_variant_sales: @recent_variant_sales, 
                         other_locations: @other_locations, 
                         selected_supplier_id: @selected_supplier_id 
                       } %>
                 <% end %>
               <% end %>
             </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>
