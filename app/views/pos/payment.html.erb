<div class="mx-auto w-full max-w-4xl h-[calc(100vh-100px)] flex flex-col items-center justify-center p-6">
  <div class="bg-white shadow-lg rounded-2xl w-full max-w-2xl p-8 border border-gray-100">
    <h1 class="text-3xl font-bold text-[#2C2C2C] mb-8 text-center">Payment</h1>

    <div class="space-y-6">
      <!-- Total Display -->
      <div class="flex justify-between items-end border-b pb-4">
        <span class="text-gray-500 font-medium text-lg">Subtotal</span>
        <span class="text-3xl font-bold text-gray-800" id="subtotal_display" data-value="<%= @total %>"><%= number_to_currency(@total, unit: '') %></span>
      </div>

      <!-- Discount Section -->
      <!-- Discount Section (Hidden if items already have individual discounts) -->
      <% unless @order.order_items.any? { |i| i.discount.to_f > 0 } %>
          <div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
            <div class="flex items-center gap-4">
                <label class="font-medium text-gray-700">Discount</label>
                <div class="w-32">
                     <input type="number" id="discount_value" placeholder="0" class="focus:ring-[#FFD100] focus:border-[#FFD100] block w-full text-lg border-gray-300 rounded-md p-2" value="0">
                </div>
                <div class="flex flex-col gap-1">
                     <label class="inline-flex items-center cursor-pointer">
                       <input type="radio" name="discount_type" value="fixed" checked class="form-radio text-[#FFD100] focus:ring-[#FFD100] h-4 w-4">
                       <span class="ml-1 text-sm">Fixed</span>
                     </label>
                     <label class="inline-flex items-center cursor-pointer">
                       <input type="radio" name="discount_type" value="percent" class="form-radio text-[#FFD100] focus:ring-[#FFD100] h-4 w-4">
                       <span class="ml-1 text-sm">%</span>
                     </label>
                </div>
            </div>
            
            <div class="text-red-500 font-bold text-xl" id="discount_display">- 0.00</div>
          </div>
      <% else %>
          <div class="bg-blue-50 p-3 rounded-lg text-center text-blue-600 text-sm mb-4">
             Individual item discounts applied. Global discount disabled.
          </div>
      <% end %>
          


       <!-- Backed Discount Code Scan -->
       <div class="text-right pt-2">
        <a href="#" id="toggle_discount_code_btn" class="text-xs text-gray-500 hover:text-[#FFD100] transition" onclick="toggleDiscountCode(event)">+ Add discount code</a>
      </div>
      
      <div id="discount_code_section" class="bg-gray-50 p-4 rounded-lg hidden transition-all duration-300 mt-2">
         <label class="block text-sm font-medium text-gray-700 mb-1">Voucher Amount</label>
         <div class="flex gap-2">
             <input type="number" id="voucher_input" placeholder="Amount..." class="focus:ring-[#FFD100] focus:border-[#FFD100] block w-full sm:text-sm border-gray-300 rounded-md p-2">
             <button type="button" onclick="redeemVoucher()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-gray-700 font-bold">Einl√∂sen</button>
         </div>
      </div>

      <!-- Vouchers Display -->
      <div class="flex justify-between items-end pb-2 text-gray-500 hidden" id="vouchers_summary_row">
        <span class="font-medium">Vouchers</span>
        <span class="text-xl font-bold text-gray-800">- <span id="vouchers_display">0.00</span></span>
      </div>


      <!-- Final Total -->
      <div class="flex justify-between items-end border-t pt-4">
        <span class="text-gray-900 font-bold text-2xl">To Pay</span>
        <span class="text-5xl font-bold text-[#2C2C2C]" id="final_total_display"><%= number_to_currency(@total, unit: '') %></span>
      </div>

      <!-- Payment Actions -->
      <%= form_with url: process_payment_pos_path(@cash_register), method: :post, id: "payment_form", class: "space-y-4" do |form| %>
        <input type="hidden" name="discount_value" id="hidden_discount_value" value="0">
        <input type="hidden" name="discount_type" id="hidden_discount_type" value="fixed">
        <input type="hidden" name="payment_method" id="payment_method" value="">
        <input type="hidden" name="amount_tendered" id="hidden_amount_tendered" value="">
        <input type="hidden" name="voucher_code" id="hidden_voucher_code" value="">
        <input type="hidden" name="voucher_amount" id="hidden_voucher_amount" value="0">

        <div class="grid grid-cols-2 gap-4 mt-8">
           <!-- Barzahlung -->
           <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 cursor-pointer hover:bg-yellow-100 transition" onclick="selectPayment('cash')">
              <h3 class="font-bold text-lg text-yellow-900 mb-2 text-center">Barzahlung</h3>
              <div class="space-y-2">
                 <label class="block text-xs font-medium text-yellow-800">Gegeben (Tendered)</label>
                 <input type="number" id="amount_tendered_input" step="0.01" class="w-full border-yellow-300 rounded p-2 focus:ring-yellow-500 focus:border-yellow-500 bg-white" placeholder="Amount given...">
                 <div class="flex justify-between text-sm font-bold text-yellow-900 pt-1">
                    <span>Change:</span>
                    <span id="change_display">0.00</span>
                 </div>
              </div>
              <button type="button" onclick="submitPayment('cash')" class="w-full mt-4 bg-[#FFD100] hover:bg-yellow-400 text-[#2C2C2C] font-bold py-3 rounded-lg shadow">Pay Cash</button>
           </div>

           <!-- Kartenzahlung -->
           <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 cursor-pointer hover:bg-blue-100 transition flex flex-col justify-between" onclick="selectPayment('card')">
               <div>
                  <h3 class="font-bold text-lg text-blue-900 mb-2 text-center">Kartenzahlung</h3>
                  <div class="text-center text-blue-400">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" />
                     </svg>
                  </div>
               </div>
               <button type="button" onclick="submitPayment('card')" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow">Pay Card</button>
           </div>
        </div>
      <% end %>
      
      <div class="text-center mt-6">
        <%= link_to "Cancel", pos_path(@cash_register), class: "text-gray-500 hover:text-gray-800 underline" %>
      </div>
    </div>
  </div>
</div>

<script>
  const subtotal = <%= @total %>;
  let voucherTotal = 0;
  let currentTotal = subtotal;

  const discountInput = document.getElementById('discount_value');
  const discountRadios = document.querySelectorAll('input[name="discount_type"]');
  const discountDisplay = document.getElementById('discount_display');
  const finalTotalDisplay = document.getElementById('final_total_display');
  const amountTenderedInput = document.getElementById('amount_tendered_input');
  const changeDisplay = document.getElementById('change_display');

  // Hidden inputs
  const hiddenDiscountValue = document.getElementById('hidden_discount_value');
  const hiddenDiscountType = document.getElementById('hidden_discount_type');
  const hiddenPaymentMethod = document.getElementById('payment_method');
  const hiddenAmountTendered = document.getElementById('hidden_amount_tendered');
  
  const paymentForm = document.getElementById('payment_form');

  function calculate() {
    let discVal = 0;
    let type = 'fixed';

    if (discountInput) {
        discVal = parseFloat(discountInput.value) || 0;
        let checkedRadio = document.querySelector('input[name="discount_type"]:checked');
        if (checkedRadio) type = checkedRadio.value;
    }
    
    let discAmount = 0;

    if (type === 'percent') {
      discAmount = subtotal * (discVal / 100.0);
    } else {
      discAmount = discVal;
    }

    let unroundedTotal = Math.max(0, subtotal - discAmount - voucherTotal);
    currentTotal = Math.round(unroundedTotal * 20) / 20;
    
    // Update UI
    if (discountDisplay) discountDisplay.textContent = '- ' + discAmount.toFixed(2);
    if (finalTotalDisplay) finalTotalDisplay.textContent = currentTotal.toFixed(2);

    // Update Hidden inputs
    hiddenDiscountValue.value = discVal;
    hiddenDiscountType.value = type;

    // Recalculate Change
    calculateChange();
  }
  
  function calculateChange() {
     let tendered = parseFloat(amountTenderedInput.value) || 0;
     let change = Math.max(0, tendered - currentTotal);
     changeDisplay.textContent = change.toFixed(2);
     hiddenAmountTendered.value = tendered;
  }

  if (discountInput) {
      discountInput.addEventListener('input', calculate);
      discountRadios.forEach(radio => radio.addEventListener('change', calculate));
  }
  amountTenderedInput.addEventListener('input', calculateChange);
  
  function redeemVoucher() {
      const input = document.getElementById('voucher_input');
      const val = parseFloat(input.value) || 0;
      
      if (val > 0) {
          voucherTotal += val;
          document.getElementById('hidden_voucher_amount').value = voucherTotal;
          
          const vRow = document.getElementById('vouchers_summary_row');
          const vDisp = document.getElementById('vouchers_display');
          
          if (vRow) vRow.classList.remove('hidden');
          if (vDisp) vDisp.textContent = voucherTotal.toFixed(2);
          
          input.value = '';
          calculate();
      }
  }

  // document.getElementById('discount_code').addEventListener('input', (e) => {
  //     document.getElementById('hidden_voucher_code').value = e.target.value;
  // });

  function submitPayment(method) {
      if (method === 'cash') {
          let tendered = parseFloat(amountTenderedInput.value) || 0;
          if (tendered < currentTotal) {
              alert("Amount tendered is less than total!");
              return;
          }
      }
      
      hiddenPaymentMethod.value = method;
      paymentForm.submit();
  }
  
  // selectPayment styling helper if needed, currently direct buttons handle submit
  function selectPayment(method) {
      // Logic to highlight selected box if we separate selection from submission
  }
  function toggleDiscountCode(event) {
      event.preventDefault();
      const section = document.getElementById('discount_code_section');
      const btn = document.getElementById('toggle_discount_code_btn');
      
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        btn.textContent = "- Hide discount code";
      } else {
        section.classList.add('hidden');
        btn.textContent = "+ Add discount code";
      }
  }
</script>
