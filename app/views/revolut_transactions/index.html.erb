<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Revolut Transactions</h1>
    <div class="flex items-center">
      <%= form_with url: import_revolut_transactions_path, multipart: true, class: "flex items-center space-x-2" do |f| %>
        <%= f.file_field :file, accept: '.csv', class: "block text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-bold file:bg-[#FFD100] file:text-gray-900 hover:file:bg-yellow-400 cursor-pointer" %>
        <%= f.submit "Import Revolut Transaktionen", class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow focus:outline-none focus:shadow-outline cursor-pointer" %>
      <% end %>
      
      <%= button_to "Export to Bexio", export_revolut_transactions_path, method: :post, class: "ml-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow focus:outline-none focus:shadow-outline cursor-pointer" %>
    </div>
  </div>

  <!-- Datalist for Autocomplete -->
  <datalist id="bexio-accounts-list">
    <% @bexio_accounts.each do |acc| %>
      <option value="<%= acc.account_number %>"><%= acc.name %></option>
    <% end %>
  </datalist>

  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <table class="min-w-full leading-normal">
      <thead>
        <tr>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Date
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Description
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Soll
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Haben
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Steuer
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Payer
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            State
          </th>
           <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Amount
          </th>
          <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Original
          </th>
        </tr>
      </thead>
      <tbody>
        <% @transactions.each do |transaction| %>
          <% bg_class = (transaction.debit_account.present? && transaction.credit_account.present? && transaction.tax_code.present?) ? "bg-green-50" : "bg-white" %>
          <tr>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm">
              <p class="text-gray-900 whitespace-no-wrap"><%= transaction.date.strftime('%d.%m.%Y') %></p>
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm">
              <p class="text-gray-900 whitespace-no-wrap"><%= transaction.description %></p>
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm" data-controller="revolut-transaction" data-revolut-transaction-id-value="<%= transaction.id %>">
                <input type="text" value="<%= transaction.debit_account %>" 
                       data-action="blur->revolut-transaction#update"
                       name="debit_account"
                       list="bexio-accounts-list"
                       class="text-xs border-gray-300 rounded shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-24 px-2 py-1">
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm" data-controller="revolut-transaction" data-revolut-transaction-id-value="<%= transaction.id %>">
                <input type="text" value="<%= transaction.credit_account %>" 
                       data-action="blur->revolut-transaction#update"
                       name="credit_account"
                       list="bexio-accounts-list"
                       class="text-xs border-gray-300 rounded shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-24 px-2 py-1">
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm" data-controller="revolut-transaction" data-revolut-transaction-id-value="<%= transaction.id %>">
                <select name="tax_code" 
                        data-action="change->revolut-transaction#update"
                        class="text-xs border-gray-300 rounded shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-24 px-2 py-1">
                    <option value="">-</option>
                    <% @bexio_tax_codes.each do |tax| %>
                        <option value="<%= tax.name %>" <%= 'selected' if transaction.tax_code == tax.name %>><%= tax.name %></option>
                    <% end %>
                </select>
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm">
              <p class="text-gray-900 whitespace-no-wrap"><%= transaction.payer %></p>
            </td>
             <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm">
              <span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight">
                <span aria-hidden="true" class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span>
                <span class="relative">
                  <% if transaction.exported.present? %>
                    Exported: <%= transaction.exported.strftime('%d.%m.%Y') %>
                  <% else %>
                    <%= transaction.state %>
                  <% end %>
                </span>
              </span>
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm text-right font-mono">
              <%= number_to_currency(transaction.total_amount, unit: "CHF ") %>
            </td>
            <td class="px-5 py-5 border-b border-gray-200 <%= bg_class %> text-sm text-right text-gray-500 font-mono">
               <% if transaction.original_currency != 'CHF' %>
                 <%= number_to_currency(transaction.original_amount, unit: "") %> <%= transaction.original_currency %>
               <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
